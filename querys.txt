	with total_alumnos_count As( 
		       select co_sucursal,count(*) AS contador_alumnos
                   from co_alumno 
                   group by co_sucursal
            ),cargos_desglose AS (
						
				with universo_cargos as (
						select suc.id as id_sucursal,									
								count(cargos.id) as cargos_pendientes_pago,
								tipo_cargo.nombre as tipo_cargo,
								sum(cargos.total) as total_cargos_desglose,
								sum(cargos.total_pagado) as total_cargos_pagados_desglose,
								(sum(cargos.total) - sum(cargos.total_pagado)) as total_cargos_pendiente_desglose
						from co_alumno a inner join co_balance_alumno balance on a.co_balance_alumno = balance.id
									inner join co_cargo_balance_alumno cargos on cargos.co_balance_alumno = balance.id			
												and cargos.pagado = false
									inner join cat_cargo tipo_cargo on  cargos.cat_cargo = tipo_cargo.id
									inner join co_sucursal suc on a.co_sucursal = suc.id
							group by suc.id,tipo_cargo.nombre
							order by suc.id
						) select c.id_sucursal,
								array_to_json(array_agg(row_to_json((c.*))))::text AS json_array
							from universo_cargos c
							group by c.id_sucursal
						
			) SELECT suc.id, suc.nombre,
                   sum(balance.total_adeudo) as total_adeuda,
                   sum(balance.total_pagos) as total_pagos,
                   sum(balance.total_cargos) as total_cargos,
                   total_alumnos.contador_alumnos,
				   cargos.json_array AS cargos 
             FROM co_alumno a inner join co_balance_alumno balance on a.co_balance_alumno = balance.id
                       inner join co_grupo grupo on a.co_grupo = grupo.id
                       inner join co_sucursal suc on a.co_sucursal =suc.id
                       inner join total_alumnos_count total_alumnos on total_alumnos.co_sucursal = suc.id             
					   inner join cargos_desglose cargos on cargos.id_sucursal = suc.id																
             WHERE a.eliminado = false 
             GROUP by suc.id,total_alumnos.contador_alumnos,cargos.json_array
             ORDER BY suc.nombre DESC
			











								with universo_cargos as (
						select suc.id as co_sucursal,
							cargos.*
						from co_sucursal suc inner join co_alumno a on a.co_sucursal = suc.id								 
								 inner join co_cargo_balance_alumno cargos on cargos.co_balance_alumno = a.co_balance_alumno			
							where  cargos.pagado = false and cargos.eliminado = false
								and a.eliminado = false								
					),estadistica  AS (
						select uc.co_sucursal,									
								count(uc.id) as cargos_pendientes_pago,
								tipo_cargo.nombre as tipo_cargo,
								sum(uc.total) as total_cargos_desglose,
								sum(uc.total_pagado) as total_cargos_pagados_desglose,
								(sum(uc.total) - sum(uc.total_pagado)) as total_cargos_pendiente_desglose								
						from cat_cargo tipo_cargo left join universo_cargos uc on uc.cat_cargo = tipo_cargo.id
						where uc.eliminado = false 
							group by tipo_cargo.nombre,uc.co_sucursal							
						) select e.co_sucursal,
							array_to_json(array_agg(row_to_json((e.*))))::text AS json_array
							from estadistica e
							group by e.co_sucursal

